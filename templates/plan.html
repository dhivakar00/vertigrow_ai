{% extends "base.html" %}

{% block title %}Farm Plan - {{ location }} - VertiGrow AI{% endblock %}

{% block content %}
<div class="container my-4">
    <!-- Plan Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <h1 class="text-success">
                        <i class="fas fa-seedling me-2"></i>
                        Vertical Farm Plan
                    </h1>
                    <p class="text-muted mb-0">
                        <i class="fas fa-map-marker-alt me-1"></i>{{ location }} • 
                        {{ area_size }}m² • 
                        ${{ "{:,.0f}".format(budget) }} budget
                        {% if created_at %}
                        • Created: {{ created_at }}
                        {% endif %}
                    </p>
                </div>
                <div>
                    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-plus me-1"></i>New Plan
                    </a>
                    <a href="{{ url_for('history') }}" class="btn btn-outline-info">
                        <i class="fas fa-history me-1"></i>History
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Weather Information -->
    {% if weather_data %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cloud me-2"></i>
                        Current Weather Conditions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 class="text-info">{{ weather_data.temp }}°C</h3>
                                <p class="text-muted">{{ weather_data.weather|title }}</p>
                            </div>
                        </div>
                        <div class="col-md-9">
                            <div class="row">
                                <div class="col-sm-4">
                                    <small class="text-muted">Humidity</small>
                                    <div><strong>{{ weather_data.humidity }}%</strong></div>
                                </div>
                                <div class="col-sm-4">
                                    <small class="text-muted">Wind Speed</small>
                                    <div><strong>{{ weather_data.wind_speed }} m/s</strong></div>
                                </div>
                                <div class="col-sm-4">
                                    <small class="text-muted">Cloud Cover</small>
                                    <div><strong>{{ weather_data.clouds }}%</strong></div>
                                </div>
                            </div>
                            {% if climate_recommendations %}
                            <div class="mt-3">
                                <span class="badge bg-info me-2">Climate Suitability: {{ climate_recommendations.climate_suitability }}</span>
                                {% if climate_recommendations.risk_factors %}
                                    {% for risk in climate_recommendations.risk_factors %}
                                    <span class="badge bg-warning text-dark me-1">{{ risk }}</span>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Crop Recommendations -->
    {% if crop_recommendations %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-seedling me-2"></i>
                        AI Crop Recommendations
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for crop in crop_recommendations %}
                        <div class="col-lg-4 mb-3">
                            <div class="card h-100 bg-dark border-success">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="card-title text-success">{{ crop.crop }}</h6>
                                        <span class="badge bg-success">{{ crop.confidence }}%</span>
                                    </div>
                                    <p class="card-text">
                                        <small class="text-muted">Suitability: {{ crop.suitability }}</small>
                                    </p>
                                    
                                    {% if crop.yield_data %}
                                    <div class="mt-3">
                                        <div class="row text-center">
                                            <div class="col-6">
                                                <div class="border-end">
                                                    <div class="text-info">{{ crop.yield_data.yield_kg_per_sqm }}</div>
                                                    <small class="text-muted">kg/m²</small>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="text-warning">{{ crop.yield_data.growth_time_days }}</div>
                                                <small class="text-muted">days</small>
                                            </div>
                                        </div>
                                        <div class="text-center mt-2">
                                            <small class="text-muted">
                                                Total: {{ crop.yield_data.total_yield_kg }}kg • 
                                                {{ crop.yield_data.harvests_per_year }} harvests/year
                                            </small>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Financial Analysis -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <!-- Cost Breakdown -->
            <div class="card border-warning mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-calculator me-2"></i>
                        Cost Analysis
                    </h5>
                </div>
                <div class="card-body">
                    {% if setup_costs and operational_costs %}
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="text-warning">Setup Costs</h6>
                            <div class="fs-4 text-success">${{ "{:,.0f}".format(setup_costs.total_setup_cost) }}</div>
                            <small class="text-muted">${{ setup_costs.adjusted_cost_per_sqm }}/m²</small>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-warning">Annual Operating</h6>
                            <div class="fs-4 text-danger">${{ "{:,.0f}".format(operational_costs.total_annual_cost) }}</div>
                            <small class="text-muted">${{ "{:,.0f}".format(operational_costs.total_monthly_cost) }}/month</small>
                        </div>
                    </div>

                    <!-- Cost Breakdown Chart -->
                    <div class="mb-4">
                        <canvas id="costBreakdownChart" width="400" height="200"></canvas>
                    </div>

                    <!-- Detailed Breakdown -->
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Setup Breakdown</h6>
                            <ul class="list-unstyled">
                                {% for component, cost in setup_costs.breakdown.items() %}
                                <li class="d-flex justify-content-between">
                                    <span>{{ component|title }}</span>
                                    <span>${{ "{:,.0f}".format(cost) }}</span>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Monthly Operating</h6>
                            <ul class="list-unstyled">
                                {% for component, cost in operational_costs.monthly_breakdown.items() %}
                                <li class="d-flex justify-content-between">
                                    <span>{{ component|title }}</span>
                                    <span>${{ "{:,.0f}".format(cost) }}</span>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- ROI Summary -->
            {% if roi_analysis %}
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        ROI Analysis
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Annual Revenue</span>
                            <strong class="text-success">${{ "{:,.0f}".format(roi_analysis.annual_revenue) }}</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Annual Profit</span>
                            <strong class="{% if roi_analysis.annual_profit > 0 %}text-success{% else %}text-danger{% endif %}">
                                ${{ "{:,.0f}".format(roi_analysis.annual_profit) }}
                            </strong>
                        </div>
                    </div>
                    
                    <div class="text-center mb-3">
                        <div class="fs-2 text-primary">{{ roi_analysis.roi_percentage }}%</div>
                        <small class="text-muted">5-Year ROI</small>
                    </div>
                    
                    <div class="mb-3">
                        {% if roi_analysis.payback_period_years %}
                        <div class="d-flex justify-content-between">
                            <span>Payback Period</span>
                            <strong>{{ roi_analysis.payback_period_years }} years</strong>
                        </div>
                        {% endif %}
                        <div class="d-flex justify-content-between">
                            <span>Profit Margin</span>
                            <strong>{{ roi_analysis.profit_margin }}%</strong>
                        </div>
                    </div>
                    
                    <div class="alert alert-{% if 'Profitable' in roi_analysis.profitability_status %}success{% else %}warning{% endif %} text-center">
                        <strong>{{ roi_analysis.profitability_status }}</strong>
                    </div>
                    
                    {% if roi_analysis.break_even_month %}
                    <div class="text-center">
                        <small class="text-muted">Break-even in {{ roi_analysis.break_even_month }} months</small>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Layout Suggestions -->
    {% if layout_suggestions %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-layer-group me-2"></i>
                        Space-Optimized Layout
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="fs-3 text-danger">{{ layout_suggestions.vertical_levels }}</div>
                                <small class="text-muted">Vertical Levels</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="fs-3 text-info">{{ layout_suggestions.space_efficiency.plants_per_sqm }}</div>
                                <small class="text-muted">Plants/m²</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="fs-3 text-success">{{ layout_suggestions.space_efficiency.yield_density }}</div>
                                <small class="text-muted">kg/m²/year</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="fs-3 text-warning">{{ layout_suggestions.space_efficiency.utilization_rate }}%</div>
                                <small class="text-muted">Space Used</small>
                            </div>
                        </div>
                    </div>

                    <h6 class="text-danger mb-3">Crop Space Allocation</h6>
                    <div class="row">
                        {% for crop_name, allocation in layout_suggestions.crop_allocation.items() %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card bg-dark">
                                <div class="card-body">
                                    <h6 class="card-title">{{ crop_name }}</h6>
                                    <div class="progress mb-2">
                                        <div class="progress-bar bg-success" style="width: {{ allocation.percentage }}%"></div>
                                    </div>
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <div>{{ allocation.area_sqm }}m²</div>
                                            <small class="text-muted">Area</small>
                                        </div>
                                        <div class="col-6">
                                            <div>{{ allocation.recommended_plants }}</div>
                                            <small class="text-muted">Plants</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <h6 class="text-danger mb-3">Infrastructure Requirements</h6>
                    <div class="row">
                        {% for item, count in layout_suggestions.infrastructure_requirements.items() %}
                        <div class="col-6 col-md-3 mb-2">
                            <div class="d-flex justify-content-between">
                                <span>{{ item|replace('_', ' ')|title }}</span>
                                <strong>{{ count }}</strong>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Revenue Projections Chart -->
    {% if revenue_projections %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        Revenue Projections by Crop
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="revenueChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Cost Breakdown Chart
    {% if setup_costs and operational_costs %}
    const costCtx = document.getElementById('costBreakdownChart').getContext('2d');
    new Chart(costCtx, {
        type: 'doughnut',
        data: {
            labels: [
                {% for component in setup_costs.breakdown.keys() %}
                '{{ component|title }}',
                {% endfor %}
            ],
            datasets: [{
                data: [
                    {% for cost in setup_costs.breakdown.values() %}
                    {{ cost }},
                    {% endfor %}
                ],
                backgroundColor: [
                    '#28a745', '#17a2b8', '#ffc107', '#dc3545', 
                    '#6f42c1', '#e83e8c', '#fd7e14', '#20c997'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#ffffff',
                        padding: 20
                    }
                }
            }
        }
    });
    {% endif %}

    // Revenue Projections Chart
    {% if revenue_projections and revenue_projections.crop_revenues %}
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    new Chart(revenueCtx, {
        type: 'bar',
        data: {
            labels: [
                {% for crop in revenue_projections.crop_revenues.keys() %}
                '{{ crop }}',
                {% endfor %}
            ],
            datasets: [{
                label: 'Annual Revenue ($)',
                data: [
                    {% for revenue_data in revenue_projections.crop_revenues.values() %}
                    {{ revenue_data.annual_revenue }},
                    {% endfor %}
                ],
                backgroundColor: '#28a745',
                borderColor: '#1e7e34',
                borderWidth: 1
            }, {
                label: 'Annual Yield (kg)',
                data: [
                    {% for revenue_data in revenue_projections.crop_revenues.values() %}
                    {{ revenue_data.annual_yield_kg }},
                    {% endfor %}
                ],
                backgroundColor: '#17a2b8',
                borderColor: '#138496',
                borderWidth: 1,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    ticks: {
                        color: '#ffffff'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    ticks: {
                        color: '#17a2b8'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                },
                x: {
                    ticks: {
                        color: '#ffffff'
                    }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        color: '#ffffff'
                    }
                }
            }
        }
    });
    {% endif %}
});
</script>
{% endblock %}
